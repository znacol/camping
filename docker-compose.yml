version: "3.5"

services:
    # golang gRPC + HTTP Server
    camping-api:
      container_name: camping-api
      hostname: camping-api
      image: golang:1.12.7-alpine3.10
      entrypoint: /bin/sh
      command:
        - "-cexu"
        - "CGO_ENABLED=0 go build -a -o /go/bin/api github.com/znacol/camping/backend/cmd/api && /go/bin/api"
      ports:
        - "50051"
        - "8000:8000"
        - "50052"
        - "8081"
      volumes:
        - ".:/go/src/github.com/znacol/camping:ro"
      environment:
        - server_env=dev
      depends_on:
        - camping-db-preload

    # mySQL database
    camping-db:
      image: postgres:11.4
      container_name: camping-db
      restart: always
      ports:
        - "5432:5432"
      environment:
        - POSTGRES_DB=camping
        - POSTGRES_USER=root
        - POSTGRES_PASSWORD=password

    # Run DB schema migrations and insert dev data
    camping-db-preload:
      container_name: camping-db-preload
      image: golang:1.12.9-buster
      entrypoint: /bin/sh
      command:
        - "/go/src/github.com/znacol/camping/docker/db_preload/db-preload.sh"
      volumes:
        - ".:/go/src/github.com/znacol/camping:ro"
      depends_on:
        - camping-db
      links:
        - camping-db

    # Angular app
    camping-web:
      build:
        context: ./web
      container_name: camping-web
      restart: always
      ports:
        - 4200:8080
      links:
        - camping-api
      volumes:
        - ./web/src:/web/src

    # API docs
    swagger:
      image: swaggerapi/swagger-ui
      container_name: swagger-docs
      restart: always
      ports:
        - 4500:8080
      environment:
        - SWAGGER_JSON=/mnt/api.swagger.json
      volumes:
        - ./backend/proto:/mnt
